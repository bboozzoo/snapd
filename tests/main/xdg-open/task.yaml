summary: Ensure snap userd allows opening a URL via xdg-open

# Not supposed to work on Ubuntu Core systems as we don't have
# a user session environment there
systems:
    - -amazon-linux-2-*
    - -centos-7-*
    - -ubuntu-14.04-*
    - -ubuntu-core-*

environment:
    # XXX: why is this here?
    DISPLAY: :0

prepare: |
    "$TESTSTOOLS"/snaps-state install-local test-snapd-desktop

    tests.session -u test prepare

    # wait for session to be ready
    tests.session -u test exec env "PATH=$PATH" retry -n 5 --wait 0.5 dbus-send \
            --session                                         \
            --dest=io.snapcraft.Launcher                      \
            --type=method_call                                \
            --print-reply                                     \
            /                                                 \
            org.freedesktop.DBus.Peer.Ping

    # setup the handler
    tests.session -u test exec sh -c 'mkdir -p ~test/.local/share/applications'
    tests.session -u test exec sh -c 'cat > ~test/.local/share/applications/test-handler.desktop' << EOF
    [Desktop Entry]
    Type=Application
    Name=Test Web Browser
    Exec=/bin/true %u
    MimeType=x-scheme-handler/randomurl;
    EOF

    # setup xdg-mime
    tests.session -u test exec mkdir -p ~test/.config
    tests.session -u test exec sh -c 'cat  > ~test/.config/mimeapps.list' << EOF
    [Default Applications]
    x-scheme-handler/randomurl=test-handler.desktop
    EOF

    # double check that the handler is properly registered
    tests.session -u test exec sh -c 'xdg-mime query default x-scheme-handler/randomurl' | \
        MATCH 'test-handler.desktop'

    # Create a small helper which will tell us if snap passes
    # the URL correctly to the right handler
    cat << 'EOF' > /tmp/xdg-open
    #!/bin/sh
    echo "$*" > /tmp/xdg-open-output
    EOF
    chmod +x /tmp/xdg-open
    if [ -e /usr/bin/xdg-open ]; then
        mv /usr/bin/xdg-open /usr/bin/xdg-open.orig
    fi
    touch /usr/bin/xdg-open
    mount --bind /tmp/xdg-open /usr/bin/xdg-open

    if [ -e /usr/bin/zenity ]; then
        mv /usr/bin/zenity /usr/bin/zenity.orig
    fi
    touch /usr/bin/zenity

restore: |
    tests.session -u test restore

    umount /usr/bin/xdg-open || true
    rm /usr/bin/xdg-open
    if [ -e /usr/bin/xdg-open.orig ]; then
        mv /usr/bin/xdg-open.orig /usr/bin/xdg-open
    fi
    rm -f ~test/.config/mimeapps.list
    rm -f ~test/.local/share/applications/test-handler.desktop

    umount /usr/bin/zenity || true
    rm -f /usr/bin/zenity
    if [ -e /usr/bin/zenity.orig ]; then
        mv /usr/bin/zenity.orig /usr/bin/zenity
    fi

execute: |
    ensure_xdg_open_output() {
        rm -f /tmp/xdg-open-output
        tests.session -u test exec test-snapd-desktop.cmd /usr/bin/xdg-open "$1"
        test -e /tmp/xdg-open-output
        test "$(head -1 /tmp/xdg-open-output)" = "$1"
    }

    # Ensure http, https, mailto, snap and help work
    ensure_xdg_open_output "https://snapcraft.io"
    ensure_xdg_open_output "http://snapcraft.io"
    ensure_xdg_open_output "mailto:talk@snapcraft.io"
    ensure_xdg_open_output "snap://snapcraft"
    ensure_xdg_open_output "help:snapcraft"
    ensure_xdg_open_output "apt:snapcraft"
    ensure_xdg_open_output "zoommtg://snapcraft.io"
    ensure_xdg_open_output "slack://5NAPPY111/magic-login/bcaf81ee-07b1-4362-9c09-ff46bd6e1bb9"
    ensure_xdg_open_output "msteams://snapcraft.io"

    # the randomurl scheme is handled by querying the mime db and then asking
    # the user to allow it, pretend the user said yes
    mount -o bind /bin/true /usr/bin/zenity
    ensure_xdg_open_output "randomurl://foo.bar"
    umount /usr/bin/zenity

    # Ensure other schemes are not passed through
    rm /tmp/xdg-open-output
    not tests.session -u test exec test-snapd-desktop.cmd /usr/bin/xdg-open ftp://snapcraft.io
    test ! -e /tmp/xdg-open-output
    not tests.session -u test exec test-snapd-desktop.cmd /usr/bin/xdg-open aabbcc
    test ! -e /tmp/xdg-open-output
    # pretend the user answers no
    mount -o bind /bin/false /usr/bin/zenity
    not tests.session -u test exec test-snapd-desktop.cmd /usr/bin/xdg-open randomurl://foo.bar
    test ! -e /tmp/xdg-open-output
    umount /usr/bin/zenity
    # no zenity at all, we cannot ask the user
    rm -f /usr/bin/zenity
    not tests.session -u test exec test-snapd-desktop.cmd /usr/bin/xdg-open randomurl://foo.bar
    test ! -e /tmp/xdg-open-output

summary: Verify that snap-confine has the right capabilities after install

details: |
    The test verifies that snap-confine has the right file capabilities during
    runtime.

execute: |
    echo "Simulating broken current symlink for core"
    SNAP_MOUNT_DIR="$(os.paths snap-mount-dir)"
    LIBEXEC_DIR="$(os.paths libexec-dir)"
    getcap "$LIBEXEC_DIR/snapd/snap-confine" | tee s-c-pkg.caps
    getcap "$SNAP_MOUNT_DIR/snapd/current/usr/lib/snapd/snap-confine" | tee s-c-snap.caps
    MATCH 'cap_sys_admin.*=ep' < s-c-pkg.caps
    MATCH 'cap_sys_admin.*=ep' < s-c-snap.caps
    echo "Capabilities from a snap and a local package are identical"
    diff -up <(cut -f2 -d' ' < s-c-pkg.caps) <(cut -f2 -d' ' < s-c-snap.caps)
